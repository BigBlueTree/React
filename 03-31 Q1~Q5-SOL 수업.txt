--Q1 부서명, 직원명(first_name),급여,커미션 컬럼을 갖는 뷰를 작성하시요.
--단 커미션 포인트가 없을 경우 0으로 반환
CREATE OR REPLACE VIEW TEST1 AS
SELECT D.DEPARTMENT_NAME,E.FIRST_NAME,E.SALARY
    ,NVL(E.COMMISSION_PCT,0)AS COMMISSION_PCT
FROM EMPLOYEES E,DEPARTMENTS D
WHERE E.DEPARTMENT_ID=D.DEPARTMENT_ID;
--Q2 부서명, 직책, 직원명, 입사일을 갖는 뷰를 작성하시오.
CREATE OR REPLACE VIEW TEST2 AS
SELECT D.DEPARTMENT_NAME,J.JOB_TITLE,E.FIRST_NAME,E.HIRE_DATE
FROM EMPLOYEES E,DEPARTMENTS D,JOBS J
WHERE E.DEPARTMENT_ID=D.DEPARTMENT_ID
AND E.JOB_ID=J.JOB_ID;
--Q3 부서테이블을 복사하여 새 테이블을 만들고 그 테이블에 직원수 컬럼을 추가하고 초기값을 셋팅한 후 
--직원의 입사 및 퇴사시 직원수 컬럼을 조정하는 트리거를 작성하시오
DROP TABLE DEPT_TEST;
CREATE TABLE DEPT_TEST AS
SELECT D.*,NVL(A.EMP_CNT,0) AS EMP_CNT
FROM DEPARTMENTS D
    ,(SELECT D1.DEPARTMENT_ID,COUNT(*)AS EMP_CNT
        FROM EMPLOYEES E, DEPARTMENTS D1
        WHERE E.DEPARTMENT_ID=D1.DEPARTMENT_ID
        GROUP BY D1.DEPARTMENT_ID) A
WHERE D.DEPARTMENT_ID=A.DEPARTMENT_ID;
SELECT * FROM DEPT_TEST;

CREATE OR REPLACE TRIGGER TRIG_TEST
AFTER INSERT OR DELETE OR UPDATE ON EMPLOYEES
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        UPDATE DEPT_TEST
        SET EMP_CNT=EMP_CNT+1
        WHERE DEPARTMENT_ID = :NEW.DEPARTMENT_ID;
    ELSIF UPDATING THEN
        IF :OLD.DEPARTMENT_ID<>:NEW.DEPARTMENT_ID THEN
            UPDATE DEPT_TEST
            SET EMP_CNT=EMP_CNT+1
            WHERE DEPARTMENT_ID = :NEW.DEPARTMENT_ID;
            UPDATE DEPT_TEST
            SET EMP_CNT=EMP_CNT-1
            WHERE DEPARTMENT_ID = :OLD.DEPARTMENT_ID;
        END IF;
    ELSIF DELETING THEN
        UPDATE DEPT_TEST
        SET EMP_CNT=EMP_CNT-1
        WHERE DEPARTMENT_ID = :OLD.DEPARTMENT_ID;
    END IF;
END TRIG_TEST;
--Q4 부서ID를 입력하면 부서명을 반환하는 함수를 작성하시오.
CREATE OR REPLACE FUNCTION FN_GET_DEPT_NAME(P_DEPT_ID IN NUMBER)
RETURN VARCHAR2
IS
    V_DEPT_NAME DEPARTMENTS.DEPARTMENT_NAME%TYPE;
BEGIN
    SELECT DEPARTMENT_NAME INTO V_DEPT_NAME
    FROM DEPARTMENTS
    WHERE DEPARTMENT_ID=P_DEPT_ID;
    RETURN V_DEPT_NAME;
END ;
SELECT FN_GET_DEPT_NAME(10) FROM DUAL;
--Q5 부서ID를 입력하면 해당 부서의 직원 목록을 출력하는 프로시저를 작성하시오.
CREATE OR REPLACE PROCEDURE PROC_TEST(P_DEPT_ID IN NUMBER)
IS
BEGIN
    FOR EMP IN(SELECT * FROM EMPLOYEES WHERE DEPARTMENT_ID=P_DEPT_ID)
    LOOP
        DBMS_OUTPUT.PUT_LINE(EMP.EMPLOYEE_ID||' '||EMP.FIRST_NAME||'...')
    END LOOP;
END PROC_TEST;